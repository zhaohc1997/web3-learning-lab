# 90 天合约 (Solidity) + 链上数据 (Python) 学习与产出打卡

---

## 目录
1. 总体目标 & 量化结果
2. 里程碑 (Milestones) 与验收标准
3. 周视图：核心主题总览
4. 周度详细任务（Week 1 ~ Week 12 + Week 13 缓冲）
5. 日常微任务模板 & 打卡区
6. 指标追踪中心 (Metrics Dashboard)
7. Gas 优化记录表
8. 安全 Checklist（迭代）
9. Sandwich 启发式迭代记录
10. 博客/文档输出登记
11. 周复盘模板 (Weekly Review)
12. 里程碑复盘模板 (Milestone Review)
13. 风险预警 & 纠偏机制
14. Backlog / Icebox（暂缓想法）
15. 下一阶段方向预留

---

## 1. 总体目标 & 量化结果

| 维度 | 90 天目标 | 验收证据 |
|------|----------|----------|
| 合约功能 | ERC20 → AMM → Staking V1 → 多池 → Pause/Emergency → 优化/打包 | `contracts/` 代码 + 测试截图 |
| 测试质量 | 单元 ≥ 40 条，Fuzz ≥ 3 组，Invariant ≥ 3 条 | `test/` + 运行日志 |
| Gas 改进 | 关键函数节省 ≥ 8–15% | `reports/gas/gas_wX.md` 对比 |
| 数据指标 | ≥ 6 核心指标 (tx/volume/unique/slippage/topN/sandwich) | `data/processed/` + Notebook |
| Sandwich 启发 | 输出 suspects 列表 + 误报分析 | `reports/final/onchain_analysis_final.md` |
| 安全心智 | Ethernaut ≥ 10 关 + Checklist v3 | `security/writeups/` + `security/checklist.md` |
| 文档输出 | 英文 Blog ≥ 8 篇 + Self‑Audit 报告 | `docs/blogs/` + `reports/audit/audit_report_v1.md` |
| Portfolio | README + Milestone Tags + 汇总页 | `README.md` + Tags |
| 学习持续性 | 连续周无断更（提交≥5次/周） | Git 提交历史图谱 |

---

## 2. 里程碑 (Milestones)

| Milestone | 目标时间 | 验收标准 |
|-----------|----------|----------|
| M1 基础成型 (v0.1-m1) | Day 30 (Week 4 末) | ERC20 + AMM + Staking V1；滑点图；≥2 Blog；初始 Fuzz；metrics_w3.csv |
| M2 中期集成 (v0.2-m2) | Day 60 (Week 8 末) | 多池+权重；Pause/Emergency；Sandwich 启发 v0；Gas 优化#1；Checklist v2；≥5 指标 |
| M3 最终交付 (v1.0-m3) | Day 90 (Week 12 末) | 全测试 (unit+fuzz+invariant)；Self‑Audit v1；Analytics Final；Gas 差异表；≥8 Blog；Summary JSON |

---

## 3. 周视图：核心主题总览

| Week | 合约主线 | 数据主线 | 安全 / 测试 | 文档输出 |
|------|----------|----------|-------------|----------|
| 1 | ERC20 基础 | 区块/时间抓取 | Ethernaut 1–2 | Blog#1 |
| 2 | AMM + events | Swap 日志解析 | Ethernaut 3–5 | Blog#2 |
| 3 | Staking V0 | 基础指标 tx/vol/addr | Ethernaut 6–7 | Blog#3 |
| 4 | Staking 奖励 V1 | 滑点分布 | Fuzz 初版 | Blog#4 + M1 |
| 5 | 多池 + 权限 | 集中度/活跃 | Invariant 初版 | Blog#5 |
| 6 | Gas 优化#1 | 时间序列聚合 | Checklist v1 | Blog#6 |
| 7 | 重构 + 注释 | Sandwich v0 | Invariant 扩展 | Blog#7 |
| 8 | Pause/Emergency | 数据清洗 / 异常 | Checklist v2 | Blog#8 + M2 |
| 9 | Gas 优化#2 (打包) | 交互仪表板 | 奖励边界 invariant | Blog#9 |
| 10 | 视图/升级槽位 | Sandwich 统计 | Self‑Audit 草稿 | Blog#10 |
| 11 | 打磨 + 脚本 | 最终 Notebook | Fuzz 深化 | Blog#11 |
| 12 | Tag + 汇总 | Summary JSON | 回归验证 | Blog#12 + Portfolio |
| 13 | 缓冲 | 修补 | 清单完善 | 复盘总结 |

---

## 4. 周度详细任务

> 勾选格式：`[ ]` → `[x]`；若延期，在末尾加 `(延)` 并记录原因于 WEEKLY_LOG。  
> “★” 表示本周最关键优先任务（必须完成）。

### Week 1
**合约**
- [ ] ★ 手写 Minimal ERC20
- [ ] 6+ 单元测试 (transfer / allowance / 边界)
- [ ] Gas 报告：`reports/gas/gas_w1.md`

**数据**
- [ ] 连接 RPC 获取最新区块高度
- [ ] 抓取最近 50 区块编号 + 时间戳 CSV
- [ ] 写 `tools/fetch_blocks.py`

**安全**
- [ ] Ethernaut：Fallback / Fallout
- [ ] Writeups 保存至 `security/writeups/w1/`

**文档 / 输出**
- [ ] Blog#1：Minimal ERC20 & Gas Baseline
- [ ] 更新 README：添加目录 & 计划
- [ ] Obsidian：Solidity 基础笔记 3 条

**复盘**
- [ ] WEEKLY_LOG 填写
- [ ] 记录 3 个疑惑点

### Week 2
**合约**
- [ ] ★ AMM addLiquidity/removeLiquidity/swap
- [ ] 测试：滑点、零流动性保护
- [ ] 事件 emit 正确

**数据**
- [ ] 抓取某 Pair Swap 日志 → `data/raw/swaps_w2.csv`
- [ ] ABI decode 函数

**安全**
- [ ] Ethernaut：CoinFlip / Telephone / Token
- [ ] 安全笔记：事件 topic 结构

**文档**
- [ ] Blog#2：AMM 设计 & Event 解码
- [ ] README 添加 AMM 架构图

**复盘**
- [ ] Gas 与功能自测总结

### Week 3
**合约**
- [ ] ★ Staking V0 deposit / withdraw
- [ ] 多用户交错测试 (2–3 用户)
- [ ] 事件：Deposit / Withdraw

**数据**
- [ ] 计算 tx_count / unique_traders / volume
- [ ] `data/processed/metrics_w3.csv`

**安全**
- [ ] Ethernaut：Delegation / Force
- [ ] 重入防护模式探索

**文档**
- [ ] Blog#3：Staking V0 设计
- [ ] README +1 功能段落

**复盘**
- [ ] 覆盖率与缺口记录

### Week 4 (M1)
**合约**
- [ ] ★ 奖励逻辑：accRewardPerShare / rewardDebt
- [ ] claim() + pendingReward()
- [ ] 多用户不同加入高度测试

**数据**
- [ ] 滑点计算 (预期 vs 实际)
- [ ] 滑点分布图 + 分位数 (p50/p90/p95)

**安全/测试**
- [ ] Fuzz 基础：随机 deposit/withdraw 序列
- [ ] Ethernaut：Vault

**文档**
- [ ] Blog#4：Reward Math
- [ ] M1 自检表写入 `reports/milestone_m1.md`

**复盘**
- [ ] 打 Tag: `v0.1-m1`

### Week 5
**合约**
- [ ] ★ addPool / allocPoint 多池支持
- [ ] 修改 allocPoint 后奖励一致性测试
- [ ] 权限控制 (Ownable/Role)

**数据**
- [ ] 计算 top5/top10 volume share
- [ ] 活跃地址数 (滚动窗口)

**安全**
- [ ] Invariant 初版：Σ user.amount == totalStake
- [ ] Fuzz：多池操作

**文档**
- [ ] Blog#5：Multi-Pool Mechanics
- [ ] README：多池图

**复盘**
- [ ] Gas 热点列表

### Week 6
**合约**
- [ ] ★ Gas 优化#1：缓存 / 常量化 / 顺序调整
- [ ] 对比表：`reports/gas/gas_w6.md`

**数据**
- [ ] 时间序列聚合：每小时或每 300 区块
- [ ] 绘制时间趋势 (tx / volume / avg slippage)

**安全**
- [ ] Ethernaut：King / Reentrancy
- [ ] Checklist v1

**文档**
- [ ] Blog#6：Gas 优化方法
- [ ] security/checklist_v1.md

**复盘**
- [ ] 优化节省百分比记录

### Week 7
**合约**
- [ ] 重构：提取库 / 内联注释 / Natspec 初稿
- [ ] 代码可读性审查

**数据**
- [ ] ★ Sandwich 启发式 v0 (A-V-B)
- [ ] suspect_sandwich_w7.csv

**安全**
- [ ] Invariant：奖励不溢出 / 负值
- [ ] 误差跟踪变量加入

**文档**
- [ ] Blog#7：Sandwich Heuristic v0
- [ ] README：数据分析章节链接

**复盘**
- [ ] 误报来源分类

### Week 8 (M2)
**合约**
- [ ] ★ Pause / Unpause
- [ ] EmergencyWithdraw 流程
- [ ] 测试：暂停后行为限制

**数据**
- [ ] 滑点异常过滤：> P99 标记 outlier
- [ ] 清洗前后对比图

**安全**
- [ ] Checklist v2（加入暂停 & 应急）
- [ ] Fuzz：随机插入 pause/unpause

**文档**
- [ ] Blog#8：Pause & Emergency
- [ ] M2 自检：`reports/milestone_m2.md`

**复盘**
- [ ] Tag: `v0.2-m2`

### Week 9
**合约**
- [ ] ★ Struct Packing / slot 复核
- [ ] Gas 优化#2：`gas_w9.md`

**数据**
- [ ] Plotly 交互仪表板 (多指标)
- [ ] 导出 metrics_dashboard_w9.html

**安全**
- [ ] Invariant：totalRewardsDistributed <= emittedRewards
- [ ] 扩展 fuzz 组合

**文档**
- [ ] Blog#9：Struct Packing Trade-offs
- [ ] README 更新 Gas 优化节

**复盘**
- [ ] 打包风险说明

### Week 10
**合约**
- [ ] 视图函数：getPoolInfo/getUserInfo
- [ ] 升级 Placeholder (storage gap)

**数据**
- [ ] Sandwich 统计：总数 / 占比 / 粗收益估计
- [ ] 时间段聚合（可疑集中区）

**安全**
- [ ] Self-Audit 草稿 Findings 草拟
- [ ] 权限矩阵表 (函数→角色)

**文档**
- [ ] Blog#10：Self-Audit Transition
- [ ] audit_report_v1.md 初稿

**复盘**
- [ ] 高风险未闭合列表

### Week 11
**合约**
- [ ] Natspec 完整
- [ ] 一键脚本：测试 + gas (`script/run_all.sh`)

**数据**
- [ ] Final Notebook 汇总章节化
- [ ] 输出 onchain_analysis_final.md

**安全**
- [ ] Fuzz 增强：多池 claim & pause 交错序列
- [ ] Invariant 精度 ±1 容忍

**文档**
- [ ] Blog#11：Analytics Finalization
- [ ] README 最终整理

**复盘**
- [ ] 剩余缺口评估

### Week 12 (M3)
**合约**
- [ ] Tag: `v1.0-m3`
- [ ] Changelog.md

**数据**
- [ ] summary.json（核心指标集中）
- [ ] suspects 最终列表 & 误报说明

**安全**
- [ ] 回归完整测试
- [ ] Checklist v3

**文档**
- [ ] Blog#12：90 Day Retrospective
- [ ] Portfolio 汇总（Notion/Markdown）
- [ ] 英文自我介绍 200 词

**复盘**
- [ ] 填里程碑复盘模板
- [ ] 能力雷达图打分

### Week 13 (缓冲 / 修补)
- [ ] 补缺测试 / 文档
- [ ] 清理临时代码 / TODO
- [ ] 决策下一阶段方向
- [ ] 生成 next_plan.md

---

## 5. 日常微任务模板

| 类型 | 微任务 | ✔ | 备注 |
|------|--------|----|------|
| 合约 | 新增或修改 ≥1 函数 | [ ] |  |
| 测试 | 跑 `forge test` 全绿 | [ ] |  |
| 数据 | 执行一次抓取 / 指标脚本 | [ ] |  |
| 安全 | 复盘一个漏洞模式或关卡 | [ ] |  |
| Gas | 标记一个昂贵函数 | [ ] |  |
| 笔记 | Obsidian 新建 1 条 | [ ] |  |
| 输出 | 更新 README / Blog 段落 | [ ] |  |
| 复盘 | 写 Daily 行日志 (WEEKLY_LOG) | [ ] |  |

**日记模板示例：**
```
2025-xx-xx
Coding: 完成 staking claim() 初稿
Test: 新增 4 条测试 全部通过
Data: 更新滑点脚本 支持分位数
Issue: accRewardPerShare 计算边界（写在笔记）
明日：补 pendingReward 测试 / 写 Blog 草稿
```

---

## 6. 指标追踪中心 (按里程碑填写)

| 指标 | Week1 | Week4 | Week8 | Week12 | 说明 |
|------|-------|-------|-------|--------|------|
| 单元测试数 |  |  |  |  | 累积 |
| Fuzz 组合数 |  |  |  |  | 场景 |
| Invariant 条目 |  |  |  |  | |
| Gas 节省最高% | 0% |  |  |  | 相对函数初版 |
| 指标总数 |  |  |  |  | 数据指标 |
| 滑点样本数 |  |  |  |  | rows |
| Sandwich suspects |  |  |  |  | 行数 |
| Blog 数 |  | 2 |  |  | |
| Checklist 版本 | v0 | v1 | v2 | v3 | |
| 合约功能完成度估值% |  |  |  |  | 主观 |

---

## 7. Gas 优化记录表

| 日期 | 函数 | 手段 | 前 (gas) | 后 (gas) | 差值 | 节省% | 备注/风险 |
|------|------|------|----------|----------|------|-------|----------|
|  | deposit | 缓存 pool 变量 |  |  |  |  |  |
|  | claim | 合并数学表达式 |  |  |  |  |  |
|  | withdraw | unchecked 自增 |  |  |  |  |  |

---

## 8. 安全 Checklist（迭代维护）

| 类别 | 项 | 状态 | 备注 |
|------|----|------|------|
| 权限 | 管理函数限制 | [ ] |  |
| 权限 | 权限撤销机制 | [ ] |  |
| 奖励 | accRewardPerShare 精度 | [ ] |  |
| 重入 | 需外部调用路径加守护 | [ ] |  |
| 重入 | claim() 顺序安全 (Effects→Interactions) | [ ] |  |
| 数学 | 溢出/下溢风险 | [ ] |  |
| 暂停 | pause 覆盖写操作 | [ ] |  |
| 应急 | emergencyWithdraw 不发奖励 | [ ] |  |
| 多池 | allocPoint 更新同步 totalAllocPoint | [ ] |  |
| 事件 | 关键状态变更 emit | [ ] |  |
| Gas | 高成本函数标记 | [ ] |  |
| Invariant | totalStake == Σ user.amount | [ ] |  |
| Invariant | 奖励不超发 | [ ] |  |
| 升级 | Storage Gap / 升级注意事项 | [ ] |  |
| 视图 | 只读函数无副作用 | [ ] |  |
| 输入 | 边界检测 (0 地址, 0 金额) | [ ] |  |
| 文档 | Natspec 完整 | [ ] |  |

---

## 9. Sandwich 启发式迭代记录

| 版本 | 参数 (窗口/滑点阈值/同地址) | suspect 数 | 误报原因 | 改进想法 | 日期 |
|------|-----------------------------|-----------|----------|----------|------|
| v0 | 3 tx / 1% / 攻击者同地址 |  |  |  |  |
| v1 |  |  |  |  |  |
| v2 |  |  |  |  |  |

---

## 10. 博客 / 文档输出登记

| # | 标题 | 路径 | 日期 | 核心亮点 | 自评分 (1-5) |
|---|------|------|------|----------|--------------|
| 1 |  | docs/blogs/ |  |  |  |
| 2 |  |  |  |  |  |
| 3 |  |  |  |  |  |
| 4 |  |  |  |  |  |
| 5 |  |  |  |  |  |
| 6 |  |  |  |  |  |
| 7 |  |  |  |  |  |
| 8 |  |  |  |  |  |
| 9 |  |  |  |  |  |
| 10 |  |  |  |  |  |
| 11 |  |  |  |  |  |
| 12 |  |  |  |  |  |

---

## 11. 周复盘模板 (复制到 WEEKLY_LOG)

```
Week X Review
1. 完成：功能/指标/测试/文档
2. 未完成（原因）：
3. 最大卡点 & 解决动作：
4. Gas / 测试 / 指标 新增：
5. 学到的 3 个核心点：
6. 技术债（下周不做会恶化）：
7. 下周 Top 3：
8. 心流评分 (1-5)：
9. 风险预警 (是否需要减范围)：
10. 本周最可展示产出链接：
```

---

## 12. 里程碑复盘模板 (M1/M2/M3)

```
Milestone Mx Review
目标回顾：
完成情况对照表：
差距项 & 原因：
最有价值的设计/代码决策：
Gas 改进总结表：
测试覆盖亮点：
数据分析亮点：
主要风险仍然存在：
下一阶段策略 (聚焦 / 扩展 / 提升)：
一句话自评：
```

---

## 13. 风险预警 & 纠偏机制

| 风险 | 触发信号 | 纠偏动作 | 最迟介入 |
|------|----------|----------|----------|
| 任务堆积 | 连续 2 周 Blog 缺失 | 减少新功能 → 优先输出 | Week 3 前 |
| 测试缺失 | 改代码 3 次没写测试 | 本周强制写覆盖 | 立即 |
| Gas 忽视 | 连续 3 周无 gas 报告 | 生成基线 + 标记热点 | 下个周末 |
| 数据停滞 | 指标 < 3 (Week6 前) | 把 2h 移出合约投入数据 | Week 6 |
| 安全不前进 | Checklist 两周没更新 | 复盘漏洞 ≥2 条 | Week 5 |
| 心理内耗 | 提交 <5 / 周 | 缩减范围 + 拆微任务 | 当周 |
| 范围蔓延 | 新想法 > 已完成核心功能 | Backlog 分类 “ICEBOX” | 即时 |

---

## 14. Backlog / Icebox

| 想法 | 类型 (功能/优化/探索) | 价值 | 复杂度 | 状态 (待评估/排期/冰箱) | 备注 |
|------|-----------------------|------|--------|-------------------------|------|
| 支持奖励动态调整 | 功能 | 高 | 中 | 冰箱 | 先完成基本生产版 |
| 多代币奖励 | 功能 | 中 | 高 | 冰箱 | 需结构改动 |
| 更精确 Sandwich (mempool) | 数据 | 高 | 高 | 冰箱 | 需私有节点 |
| Rust 重写抓取工具 | 优化 | 中 | 中 | 待评估 | 等数据量增大 |
| ZK 统计扩展 | 探索 | 中 | 高 | 冰箱 | Day 90 后 |
| Formal Verification (Scribble) | 安全 | 高 | 高 | 冰箱 | 先自审 |

---

## 15. 下一阶段方向预留 (Week 12 填)

| 方向候选 | 吸引力 (1-5) | 成本 (1-5) | 决策 | 第一步动作 |
|----------|--------------|-----------|------|-----------|
| 协议客户端 / Go |  |  |  |  |
| ZK / 电路 |  |  |  |  |
| 安全审计深化 |  |  |  |  |
| MEV 数据扩展 |  |  |  |  |
| 高性能索引 (Rust) |  |  |  |  |

---

## 附：快速执行指令备忘 (Cheat Sheet)

| 场景 | 命令 |
|------|------|
| 运行全部测试 | `forge test` |
| Gas 报告输出 | `forge test --gas-report > reports/gas/gas_wX.md` |
| 指定测试 | `forge test --match-test testClaim` |
| 抓日志脚本 | `python tools/fetch_swaps.py --pair <addr> --start <block>` |
| 生成指标 | `python tools/compute_metrics.py` |
| Notebook 启动 | `jupyter notebook` |
| 创建 Tag | `git tag -a v0.1-m1 -m "Milestone 1"; git push origin v0.1-m1` |

---


（文件完）